<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FolderService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">note</a> &gt; <a href="index.source.html" class="el_package">com.jundaai.note.service</a> &gt; <span class="el_source">FolderService.java</span></div><h1>FolderService.java</h1><pre class="source lang-java linenums">package com.jundaai.note.service;

import com.jundaai.note.exception.FolderNameBlankException;
import com.jundaai.note.exception.FolderNameConflictException;
import com.jundaai.note.exception.FolderNotFoundException;
import com.jundaai.note.exception.RootPreservationException;
import com.jundaai.note.form.folder.FolderCreationForm;
import com.jundaai.note.form.folder.FolderUpdateForm;
import com.jundaai.note.form.folder.FolderOperationType;
import com.jundaai.note.model.Folder;
import com.jundaai.note.repository.FolderRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.transaction.Transactional;
import java.time.ZonedDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;

@Service
<span class="fc" id="L23">@Slf4j</span>
public class FolderService {

    private final FolderRepository folderRepository;

    @Autowired
<span class="fc" id="L29">    public FolderService(FolderRepository folderRepository) {</span>
<span class="fc" id="L30">        this.folderRepository = folderRepository;</span>
<span class="fc" id="L31">    }</span>

    public List&lt;Folder&gt; getAllFolders() {
<span class="fc" id="L34">        log.info(&quot;Get all folders&quot;);</span>
<span class="fc" id="L35">        return folderRepository.findAll();</span>
    }

    public Folder getFolderById(Long folderId) {
<span class="fc" id="L39">        log.info(&quot;Get folder by id: {}&quot;, folderId);</span>
<span class="fc" id="L40">        return folderRepository</span>
<span class="fc" id="L41">                .findById(folderId)</span>
<span class="fc" id="L42">                .orElseThrow(() -&gt; new FolderNotFoundException(folderId));</span>
    }

    public List&lt;Folder&gt; getSubFoldersByParentId(Long parentId) {
<span class="fc" id="L46">        log.info(&quot;Get sub-folders by parent id: {}&quot;, parentId);</span>
<span class="fc" id="L47">        return folderRepository</span>
<span class="fc" id="L48">                .findSubFoldersByParentId(parentId)</span>
<span class="fc" id="L49">                .orElseThrow(() -&gt; new FolderNotFoundException(parentId));</span>
    }

    @Transactional
    public Folder createFolderByParentId(Long parentId, FolderCreationForm folderCreationForm) {
<span class="fc" id="L54">        log.info(&quot;Create new folder: {}, parent folder id: {}&quot;, folderCreationForm, parentId);</span>

<span class="fc" id="L56">        String folderName = folderCreationForm.getName();</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">        if (folderName.equals(&quot;root&quot;)) {</span>
<span class="fc" id="L58">            throw new RootPreservationException(FolderOperationType.CREATE_FOLDER);</span>
        }
<span class="fc bfc" id="L60" title="All 2 branches covered.">        if (folderName.isBlank()) {</span>
<span class="fc" id="L61">            throw new FolderNameBlankException();</span>
        }

<span class="fc" id="L64">        Folder parent = folderRepository</span>
<span class="fc" id="L65">                .findById(parentId)</span>
<span class="fc" id="L66">                .orElseThrow(() -&gt; new FolderNotFoundException(parentId));</span>
<span class="fc" id="L67">        boolean nameConflicted = folderRepository.existsByNameWithSameParent(folderName, parent);</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">        if (nameConflicted) {</span>
<span class="fc" id="L69">            throw new FolderNameConflictException(folderName);</span>
        }

<span class="fc" id="L72">        ZonedDateTime now = ZonedDateTime.now();</span>
        Folder folder = Folder
<span class="fc" id="L74">                .builder()</span>
<span class="fc" id="L75">                .name(folderName)</span>
<span class="fc" id="L76">                .createdAt(now)</span>
<span class="fc" id="L77">                .updatedAt(now)</span>
<span class="fc" id="L78">                .parentFolder(parent)</span>
<span class="fc" id="L79">                .subFolders(new ArrayList&lt;&gt;())</span>
<span class="fc" id="L80">                .notes(new ArrayList&lt;&gt;())</span>
<span class="fc" id="L81">                .build();</span>
<span class="fc" id="L82">        folder = folderRepository.save(folder);</span>

<span class="fc" id="L84">        List&lt;Folder&gt; parentSubFolders = parent.getSubFolders();</span>
<span class="fc" id="L85">        parentSubFolders.add(folder);</span>
<span class="fc" id="L86">        parent.setSubFolders(parentSubFolders);</span>
<span class="fc" id="L87">        parent.setUpdatedAt(now);</span>
<span class="fc" id="L88">        folderRepository.save(parent);</span>

<span class="fc" id="L90">        return folder;</span>
    }

    @Transactional
    public Folder updateFolderById(Long folderId, FolderUpdateForm updateForm) {
<span class="fc" id="L95">        log.info(&quot;Update folder by id: {}, form: {}&quot;, folderId, updateForm);</span>
<span class="fc" id="L96">        ZonedDateTime now = ZonedDateTime.now();</span>
<span class="fc" id="L97">        Folder folder = folderRepository</span>
<span class="fc" id="L98">                .findById(folderId)</span>
<span class="fc" id="L99">                .orElseThrow(() -&gt; new FolderNotFoundException(folderId));</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (folder.getName().equals(&quot;root&quot;)) {</span>
<span class="fc" id="L101">            throw new RootPreservationException(updateForm.getUpdateType());</span>
        }

<span class="fc bfc" id="L104" title="All 3 branches covered.">        switch (updateForm.getUpdateType()) {</span>
            case FolderOperationType.RENAME_FOLDER -&gt; {
<span class="fc" id="L106">                String newName = updateForm.getNewName();</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">                if (newName.equals(&quot;root&quot;)) {</span>
<span class="fc" id="L108">                    throw new RootPreservationException(FolderOperationType.RENAME_FOLDER);</span>
                }
<span class="fc bfc" id="L110" title="All 2 branches covered.">                if (newName.isBlank()) {</span>
<span class="fc" id="L111">                    throw new FolderNameBlankException();</span>
                }
<span class="fc" id="L113">                boolean nameConflicted = folderRepository.existsByNameWithSameParent(newName, folder.getParentFolder());</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">                if (nameConflicted) {</span>
<span class="fc" id="L115">                    throw new FolderNameConflictException(newName);</span>
                }
<span class="fc" id="L117">                folder.setName(newName);</span>
<span class="fc" id="L118">            }</span>
            case FolderOperationType.MOVE_FOLDER -&gt; {
<span class="fc" id="L120">                Long toParentId = updateForm.getToParentId();</span>
<span class="fc" id="L121">                Folder toParent = folderRepository</span>
<span class="fc" id="L122">                        .findById(toParentId)</span>
<span class="fc" id="L123">                        .orElseThrow(() -&gt; new FolderNotFoundException(toParentId));</span>
<span class="fc" id="L124">                Folder fromParent = folder.getParentFolder();</span>

<span class="fc bfc" id="L126" title="All 2 branches covered.">                if (Objects.equals(toParent, folder)) {</span>
<span class="fc" id="L127">                    log.error(&quot;Cannot move folder to self. Abort.&quot;);</span>
<span class="fc" id="L128">                    return folder;</span>
                }
<span class="fc bfc" id="L130" title="All 2 branches covered.">                if (Objects.equals(toParent, fromParent)) {</span>
<span class="fc" id="L131">                    log.error(&quot;Destination folder identical as current parent folder. Abort.&quot;);</span>
<span class="fc" id="L132">                    return folder;</span>
                }

<span class="fc" id="L135">                folder.setParentFolder(toParent);</span>

<span class="fc" id="L137">                List&lt;Folder&gt; fromParentSubFolders = fromParent.getSubFolders();</span>
<span class="fc" id="L138">                fromParentSubFolders.remove(folder);</span>
<span class="fc" id="L139">                fromParent.setSubFolders(fromParentSubFolders);</span>
<span class="fc" id="L140">                fromParent.setUpdatedAt(now);</span>
<span class="fc" id="L141">                folderRepository.save(fromParent);</span>

<span class="fc" id="L143">                List&lt;Folder&gt; toParentSubFolders = toParent.getSubFolders();</span>
<span class="fc" id="L144">                toParentSubFolders.add(folder);</span>
<span class="fc" id="L145">                toParent.setSubFolders(toParentSubFolders);</span>
<span class="fc" id="L146">                toParent.setUpdatedAt(now);</span>
<span class="fc" id="L147">                folderRepository.save(toParent);</span>
<span class="fc" id="L148">            }</span>
<span class="fc" id="L149">            default -&gt; throw new IllegalArgumentException(&quot;Unsupported folder operation type.&quot;);</span>
        }
<span class="fc" id="L151">        folder.setUpdatedAt(now);</span>
<span class="fc" id="L152">        return folderRepository.save(folder);</span>
    }

    @Transactional
    public void deleteFolderById(Long folderId) {
<span class="fc" id="L157">        log.info(&quot;Delete folder by id: {}&quot;, folderId);</span>
<span class="fc" id="L158">        Folder folder = folderRepository</span>
<span class="fc" id="L159">                .findById(folderId)</span>
<span class="fc" id="L160">                .orElseThrow(() -&gt; new FolderNotFoundException(folderId));</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">        if (Objects.equals(folder.getName(), &quot;root&quot;)) {</span>
<span class="fc" id="L162">            throw new RootPreservationException(FolderOperationType.DELETE_FOLDER);</span>
        }
<span class="fc" id="L164">        folderRepository.deleteById(folderId);</span>
<span class="fc" id="L165">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>